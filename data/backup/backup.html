<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#06c1db">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>iOS Support - ƒêo√†n</title>
  <link rel="icon" type="image/png" href="./image/appstore.png">
  <link rel="stylesheet" href="./main.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <main>
    <div id="qrcode"></div>
    <h2 class="rainbow-animated">Ph·∫°m B√¨nh ƒêo√†n</h2>
    <textarea id="deviceKeysInput" placeholder="Nh·∫≠p: B62 DNPRW1CSHFLR (M·ªói m√°y 1 d√≤ng)"></textarea>
    <a class="btn" href="#" id="bookmarkletbackup">K√©o l√™n thanh d·∫•u trang!</a>
  </main>

  <script>
    new QRCode(document.getElementById("qrcode"), "https://doanpbvn.github.io/ios");

    document.addEventListener('DOMContentLoaded', () => {
      const deviceKeysInput = document.getElementById('deviceKeysInput');
      const bookmarkletbackup = document.getElementById('bookmarkletbackup');

      function generateBookmarklet() {
        const lines = deviceKeysInput.value.trim().split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) {
          bookmarkletbackup.href = "#";
          bookmarkletbackup.textContent = "B·∫°n ch∆∞a nh·∫≠p Key k√¨a ^^";
          return;
        }

        const names = [], keys = [];
        lines.forEach(line => {
          const parts = line.trim().split(' ');
          const name = parts[0];
          const key = parts.slice(1).join(' ');
          if (name && key) {
            names.push(name);
            keys.push(`"${key}"`);
          }
        });

        const formattedKeys = keys.join(',');
        const defaultName = names.length === 1 ? names[0] : `${names[0]} - ${names[names.length - 1]}`;
        let customName = prompt("Nh·∫≠p t√™n backup t√πy ch·ªânh:", defaultName);
        if (!customName || customName.trim() === "") customName = defaultName;

        const bookmarkletCode = `(async () => {
          let skipWaiting = false;
          let forceStop = false;
          let remainingTime = 0;
          let lastSpaceLogTime = 0;

          function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          function onKeydown(e) {
            const now = Date.now();
            if (e.key.toLowerCase() === "s") {
              skipWaiting = true;
              console.log("‚è© ƒê√£ b·ªè qua th·ªùi gian ch·ªù!");
            }
            if (e.code === "Space") {
              e.preventDefault();
              if (now - lastSpaceLogTime > 1000) {
                console.log(\`‚è≥ C√≤n l·∫°i: \${Math.max(remainingTime / 1000, 0)}s\`);
                lastSpaceLogTime = now;
              }
            }
            if (e.key === "Escape") {
              forceStop = true;
              console.log("üõë ƒê√£ tho√°t script theo y√™u c·∫ßu (ESC)!");
            }
          }

          window.addEventListener("keydown", onKeydown);

          async function smartWait(ms) {
            const step = 1000;
            remainingTime = ms;
            while (remainingTime > 0 && !skipWaiting && !forceStop) {
              await delay(step);
              remainingTime -= step;
            }
            skipWaiting = false;
          }

          const totalRuns = parseInt(prompt("Nh·∫≠p s·ªë l∆∞·ª£t ch·∫°y:"), 10);
          if (!totalRuns) return alert("Thi·∫øu s·ªë l∆∞·ª£t ch·∫°y!");

          const devices = ${JSON.stringify(lines)}.map(line => {
            const parts = line.trim().split(/\\s+/);
            return { name: parts[0], id: parts[1] };
          }).filter(d => d.name && d.id);

          async function fakeCleanDevice(device) {
            console.log(\`üßπ ƒêang FakeClean!\`);
            await fetch(\`https://ifake.pro/manager/device/\${device.id}/tools\`, {
              method: "POST",
              headers: { "accept": "*/*", "content-type": "application/x-www-form-urlencoded; charset=UTF-8" },
              body: "action=fake_clean",
              credentials: "include"
            });
          }

          async function sendScriptToDevices(scriptLines) {
            const params = new URLSearchParams();
            devices.forEach(d => params.append("serial_numbers[]", d.id));
            params.append("scripts", scriptLines.join("\\n"));
            params.append("song_song", "0");
            console.log("üì§ Open TiktokLite > Skip L·ª±a Ch·ªçn > L∆∞·ªõt Video");
            await fetch("https://ifake.pro/manager/devices/send_script_to_devices", {
              method: "POST",
              headers: { "accept": "*/*", "content-type": "application/x-www-form-urlencoded; charset=UTF-8" },
              body: params.toString(),
              credentials: "include"
            });
          }

          async function backupDevice(device, runIndex) {
            const now = new Date();
            const timestamp = \`\${String(now.getDate()).padStart(2, '0')}-\${String(now.getMonth() + 1).padStart(2, '0')}\`;
            const sessionRes = await fetch(\`https://ifake.pro/manager/device/\${device.id}/sessions\`, {
              method: "POST",
              headers: { "accept": "*/*", "content-type": "application/x-www-form-urlencoded; charset=UTF-8" },
              body: "action=get_sessions_from_server",
              credentials: "include"
            });
            const sessionData = await sessionRes.json();
            const totalSessions = (sessionData.html.match(/Folder:\\s*([A-F0-9-]{36})<\\/span>/g) || []).length;
            const backupName = \`\${device.name}-\${timestamp}-\${totalSessions + 1}\`;
            console.log(\`üíæ Backup \${device.name}: \${backupName}\`);
            await fetch(\`https://ifake.pro/manager/device/\${device.id}/sessions\`, {
              method: "POST",
              headers: { "accept": "*/*", "content-type": "application/x-www-form-urlencoded; charset=UTF-8" },
              body: \`action=backup&name=\${backupName}\`,
              credentials: "include"
            });
          }
            const behaviorScript = [
                        "close:com.ss.iphone.ugc.tiktok.lite",
                        "waitrand:1|2",
                        "open:com.ss.iphone.ugc.tiktok.lite",
                        "waitrand:4|8",
                        "open:com.ss.iphone.ugc.tiktok.lite",
                        "waitrand:10|15",
                        "open:com.ss.iphone.ugc.tiktok.lite",
                        "apptouchtext:skip,last",
                        "apptouchtext:dance,last",
                        "apptouchtext:family,last",
                        "apptouchtext:comedy,last",
                        "apptouchtext:next,last",
                        "waitrand:1|2",
                        "open:com.ss.iphone.ugc.tiktok.lite",
                        "waitrand:1|2",
                        ...Array(7).fill("smartmoveextend:right,up,0.3").flatMap(cmd => [cmd, "waitrand:1|2"])
                    ];
          for (let run = 0; run < totalRuns; run++) {
            if (forceStop) break;
            console.log(\`üöÄ L∆∞·ª£t ch·∫°y \${run + 1}/\${totalRuns}\`);

            for (const device of devices) {
              if (forceStop) break;
              await fakeCleanDevice(device);
            }

            console.log("‚è± ƒê·ª£i 60s sau fake clean...");
            await smartWait(60000);
            if (forceStop) break;

            await sendScriptToDevices(behaviorScript);

            console.log("‚è± ƒê·ª£i 120s x·ª≠ l√Ω script...");
            await smartWait(120000);
            if (forceStop) break;

            for (const device of devices) {
              if (forceStop) break;
              await backupDevice(device, run);
            }

            console.log("‚è± ƒê·ª£i 60s ƒë·ªÉ backup...");
            await smartWait(60000);
          }

          window.removeEventListener("keydown", onKeydown);
          console.log("‚úÖ HO√ÄN T·∫§T TO√ÄN B·ªò SCRIPT!");
        })();`;

        const encodedBookmarklet = `javascript:${encodeURIComponent(bookmarkletCode)}`;
        bookmarkletbackup.href = encodedBookmarklet;
        bookmarkletbackup.textContent = `${customName} T·∫°o Ph√¥i`;
      }

      deviceKeysInput.addEventListener('input', generateBookmarklet);
      generateBookmarklet();
    });
  </script>

  <footer style="text-align: center;">&copy; 2025 - DoanPB - All Rights Reserved.</footer>
</body>
</html>
