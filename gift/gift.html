<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lưu Gift lên Google Sheet</title>
  <link rel="stylesheet" href="/gift/gift.css">
</head>
<body>
<main>
  <h3>Save Gift - TrangKyla</h3>
  <div id="statusContainer" class="status-container"></div>

  <div class="input-container">
    <p>LINK GIFT</p>
    <input type="text" id="giftLink" placeholder="Nhập link gift bất kỳ">
  </div>

  <div class="input-container">
    <p>LOẠI GIFT <i style="font-size: 14px; color: red;">(Chọn hoặc nhập giá trị khác.)</i></p>
    <input type="number" id="giftTypeCustom" placeholder="Nhập giá trị khác" value="100">
  </div>

  <h3>Sheet cần lưu</h3>
  <div class="button-container sheet-btns">
    <button onclick="sendGiftToSheet('Dàn A')">Dàn A</button>
    <button onclick="sendGiftToSheet('Dàn B')">Dàn B</button>
    <button onclick="sendGiftToSheet('Dàn C')">Dàn C</button>
  </div>

  <h3>Chọn Gift Nhanh</h3>
  <div class="button-container">
    <button type="button" class="gift-type-btn" data-value="100">100</button>
    <button type="button" class="gift-type-btn" data-value="500">500</button>
    <button type="button" class="gift-type-btn" data-value="1000">1000</button>
    <button type="button" class="gift-type-btn" data-value="3000">3000</button>
  </div>

  <button onclick="sendGiftToSheet('Sheet1')" style="width: 100%; margin-top: 10px;">Lưu vào Tổng</button>
</main>
  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxBduMz54Rd-3c1Pvz8k5AdEvXHF-JyVJF3dGKHeCfdYuor3SeS1du6teBmYBzcKPaPSQ/exec"; // Thay URL của bạn ở đây
    let isSubmitting = false;
    let lastSubmitTime = 0;

    function showStatus(message, type) {
  // Lấy phần tử chứa trạng thái
  const statusContainer = document.getElementById('statusContainer');

  // Làm mới nội dung container (xóa các thông báo cũ)
  statusContainer.innerHTML = '';

  // Lấy thời gian hiện tại
  const timestamp = new Date().toLocaleString('vi-VN', { 
    hour12: false, 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit' 
  });

  // Tạo phần tử thông báo mới
  const statusMessage = document.createElement('div');
  statusMessage.className = `status-message ${type}`;
  statusMessage.innerHTML = `<strong>${timestamp}</strong>: ${message}`;

  // Thêm thông báo mới vào container
  statusContainer.appendChild(statusMessage);
}

    function canSubmit() {
      const now = Date.now();
      if (now - lastSubmitTime < 2500) {
        showStatus(`Vui lòng đợi ${Math.ceil((2500 - (now - lastSubmitTime)) / 1000)} giây...`, 'error');
        return false;
      }
      lastSubmitTime = now;
      return true;
    }

    function sendGiftToSheet(sheetName) {
      if (isSubmitting || !canSubmit()) return;

      const giftLink = document.getElementById('giftLink').value.trim();
      const giftType = document.getElementById('giftTypeCustom').value.trim();

      if (!giftLink) {
        showStatus('Vui lòng nhập link gift!', 'error');
        return;
      }

      isSubmitting = true;
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      showStatus('Đang gửi dữ liệu...', '');

      const params = new URLSearchParams({
        sheet: sheetName,
        type: giftType,
        link: giftLink
      });

      fetch(scriptURL + "?" + params.toString(), { method: 'GET' })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.text();
        })
        .then(data => {
          showStatus('✅ Lưu gift thành công!', 'success');
          document.getElementById('giftLink').value = '';
        })
        .catch(error => {
          console.error('Lỗi gửi dữ liệu:', error);
          showStatus(`❌ Gửi dữ liệu thất bại: ${error.message}`, 'error');
        })
        .finally(() => {
          isSubmitting = false;
          document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.gift-type-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.gift-type-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('giftTypeCustom').value = this.dataset.value;
        });
      });
    });
  </script>
<footer>&copy; 2025 - DoanPB - All Rights Reserved.</footer>
</body>
</html>
